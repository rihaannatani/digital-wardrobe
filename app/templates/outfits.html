{% extends "base.html" %}
{% block content %}

{# Build a clean base query string once (no whitespace bugs) #}
{% set base_q = "context=" ~ context ~ "&locked=" ~ locked %}
{% if outfit.get('top') %}{% set base_q = base_q ~ "&top_id=" ~ outfit['top']['id'] %}{% endif %}
{% if outfit.get('bottom') %}{% set base_q = base_q ~ "&bottom_id=" ~ outfit['bottom']['id'] %}{% endif %}
{% if outfit.get('shoes') %}{% set base_q = base_q ~ "&shoes_id=" ~ outfit['shoes']['id'] %}{% endif %}
{% if outfit.get('outerwear') %}{% set base_q = base_q ~ "&outerwear_id=" ~ outfit['outerwear']['id'] %}{% endif %}

<div class="row" style="justify-content:space-between; align-items:center;">
  <h2 style="margin:0;">Outfits</h2>

  <div class="row" style="gap:12px; align-items:center;">
    <a href="/items">Wardrobe</a>
    <a href="/history">History</a>
  </div>
</div>

<div class="card" style="margin-top:12px;">
  <div class="row" style="justify-content:space-between; align-items:center;">
    <form method="get" action="/outfits" class="row" style="gap:10px; align-items:center;">
      <label class="muted">Context</label>
      <input name="context" value="{{ context }}" />
      <input type="hidden" name="locked" value="{{ locked }}" />

      {% if outfit.get("top") %}<input type="hidden" name="top_id" value="{{ outfit['top']['id'] }}" />{% endif %}
      {% if outfit.get("bottom") %}<input type="hidden" name="bottom_id" value="{{ outfit['bottom']['id'] }}" />{% endif %}
      {% if outfit.get("shoes") %}<input type="hidden" name="shoes_id" value="{{ outfit['shoes']['id'] }}" />{% endif %}
      {% if outfit.get("outerwear") %}<input type="hidden" name="outerwear_id" value="{{ outfit['outerwear']['id'] }}" />{% endif %}

      <button type="submit">Refresh</button>
    </form>

    <a href="/outfits?{{ base_q }}&shuffle=1">
      <button type="button">Shuffle unlocked</button>
    </a>
  </div>
</div>

{% for slot in slots %}
  {% set it = outfit.get(slot) %}
  {% set is_locked = (slot in locked_set) %}

  <div class="card">
    <div class="row" style="justify-content:space-between; align-items:center;">
      <div class="row" style="gap:10px; align-items:center;">
        <strong style="text-transform:capitalize;">{{ slot }}</strong>
        <span class="muted">{% if is_locked %}locked{% else %}unlocked{% endif %}</span>
      </div>

      <div class="row" style="gap:8px; align-items:center;">
        <a href="/outfits?{{ base_q }}&toggle_lock={{ slot }}">
          <button type="button">{% if is_locked %}Unlock{% else %}Lock{% endif %}</button>
        </a>

        <a href="/outfits?{{ base_q }}&reroll={{ slot }}">
          <button type="button" {% if is_locked %}disabled{% endif %}>&lt; &gt;</button>
        </a>
      </div>
    </div>

    {% if it and it["image_path"] %}
      <img src="{{ it['image_path'] }}"
           style="width:100%; max-width:420px; height:260px; object-fit:cover; border-radius:12px; margin-top:10px;" />
    {% else %}
      <div class="muted" style="margin-top:10px;">No image for this slot yet.</div>
    {% endif %}

    {% if it %}
      <div style="margin-top:10px;">
        <div><strong>{{ it["name"] }}</strong></div>
        <div class="muted">{{ it["category"] }} | {{ it["color_primary"] }}</div>
      </div>
    {% endif %}
  </div>
{% endfor %}

<div class="card">
  <form method="post" action="/outfits/save">
    <input type="hidden" name="context" value="{{ context }}" />
    <input type="hidden" name="locked" value="{{ locked }}" />

    {% for slot in slots %}
      {% if outfit.get(slot) %}
        <input type="hidden" name="{{ slot }}_id" value="{{ outfit[slot]['id'] }}" />
      {% endif %}
    {% endfor %}

    <button type="submit">Save Outfit</button>
  </form>
</div>

{% endblock %}
